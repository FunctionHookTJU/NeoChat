# 桥接服务器配置指南

## 🎯 桥接服务器的作用

桥接服务器将浏览器的 WebSocket 连接转换为 TCP 连接，使浏览器客户端可以连接到 TCP 服务器（包括内网穿透的服务器）。

```
浏览器 --WebSocket--> 桥接服务器 --TCP--> TCP服务器
```

## ⚙️ 配置方法

### 方法 1：交互式配置（推荐）

首次运行时会自动引导配置：

```bash
python bridge_server.py
```

选择服务器类型：
- **选项 1**：本地服务器 (127.0.0.1:9999)
- **选项 2**：内网穿透服务器（输入穿透地址）

### 方法 2：编辑配置文件

创建或编辑 `bridge_config.json`：

```json
{
    "tcp_host": "111.161.121.11",
    "tcp_port": 57424,
    "ws_host": "0.0.0.0",
    "ws_port": 8080
}
```

**参数说明：**
- `tcp_host`: TCP 服务器地址（本地或内网穿透地址）
- `tcp_port`: TCP 服务器端口
- `ws_host`: 桥接服务器监听地址（0.0.0.0 表示所有网卡）
- `ws_port`: 桥接服务器监听端口

### 方法 3：命令行参数

```bash
# 连接到本地服务器
python bridge_server.py 127.0.0.1 9999

# 连接到内网穿透服务器
python bridge_server.py 111.161.121.11 57424
```

## 📋 使用场景

### 场景 1：本地测试

```json
{
    "tcp_host": "127.0.0.1",
    "tcp_port": 9999
}
```

启动顺序：
1. `python server_tcp.py` - 启动 TCP 服务器
2. `python bridge_server.py` - 启动桥接服务器
3. 打开 `client.html` - 连接到 `localhost:8080`

### 场景 2：连接内网穿透服务器

```json
{
    "tcp_host": "111.161.121.11",
    "tcp_port": 57424
}
```

启动顺序：
1. 远程机器运行 `python server_tcp.py`
2. 远程机器配置好内网穿透（TCP 隧道）
3. 本地运行 `python bridge_server.py`（使用穿透地址配置）
4. 本地打开 `client.html` - 连接到 `localhost:8080`

### 场景 3：部署桥接服务器到远程

如果你有远程服务器，可以将桥接服务器部署到远程：

```json
{
    "tcp_host": "127.0.0.1",
    "tcp_port": 9999,
    "ws_host": "0.0.0.0",
    "ws_port": 8080
}
```

然后配置 HTTP 隧道穿透桥接服务器的 8080 端口，浏览器连接穿透后的 WebSocket 地址。

## 🔧 配置文件位置

配置文件位于项目根目录：`bridge_config.json`

如果文件不存在，首次运行时会自动创建。

## 💡 最佳实践

### 本地开发
```
TCP服务器: 本地运行
桥接服务器: 本地运行，连接到 127.0.0.1:9999
浏览器: 连接到 ws://localhost:8080
```

### 内网穿透（朋友连接）
```
TCP服务器: 本地运行 + TCP隧道穿透
桥接服务器: 每个朋友本地运行，配置你的穿透地址
浏览器: 每个人连接自己本地的 ws://localhost:8080
```

### 完全远程部署
```
TCP服务器: 远程服务器运行
桥接服务器: 远程服务器运行 + HTTP隧道穿透
浏览器: 连接到 ws://your-bridge-domain.com
```

## ⚠️ 注意事项

1. **配置文件优先级**：命令行参数 > 配置文件 > 默认值
2. **端口冲突**：确保 8080 端口未被占用
3. **网络连通性**：确保桥接服务器能访问 TCP 服务器地址
4. **安全性**：如果部署到公网，建议配置访问控制

## 🆘 故障排查

### 桥接服务器启动失败
```bash
# 检查端口占用
netstat -ano | findstr 8080

# 更改端口
# 编辑 bridge_config.json，修改 ws_port
```

### 无法连接到 TCP 服务器
```bash
# 测试 TCP 连接
python test_tunnel.py
# 输入配置的 tcp_host 和 tcp_port
```

### 浏览器无法连接桥接服务器
1. 确认桥接服务器正在运行
2. 浏览器地址正确：`ws://localhost:8080`
3. 检查浏览器控制台错误信息

## 📝 示例配置

### 配置 1：本地开发
```json
{
    "tcp_host": "127.0.0.1",
    "tcp_port": 9999,
    "ws_host": "0.0.0.0",
    "ws_port": 8080
}
```

### 配置 2：创蓝隧道穿透
```json
{
    "tcp_host": "111.161.121.11",
    "tcp_port": 57424,
    "ws_host": "0.0.0.0",
    "ws_port": 8080
}
```

### 配置 3：自定义端口
```json
{
    "tcp_host": "192.168.1.100",
    "tcp_port": 9999,
    "ws_host": "0.0.0.0",
    "ws_port": 3000
}
```
